jQuery(document).ready(function($){function checkUsage(content){var _formlist=[];$("#save-email-template-button").prop("disabled",!1),$("#token-error").hide(600),$('div[data-role="email-template-holder"] div.ib-pill-small').each(function(){var $me=$(this),token=$me.data("token");content.indexOf("{{"+token+"}}")!==-1?$me.hasClass("ib-used")||("undefined"!=typeof field_array&&($.each(field_array,function(index,value){value.indexOf(token)==-1&&_formlist.push(index)}),_formlist.length&&($("#token-error").text($(this).text()+" is not part of the form data of "+_formlist.toString()+" Contact Form. It cannot be added to this template").show(600),$("#save-email-template-button").prop("disabled",!0))),$me.addClass("ib-used"),attachToken($me.attr("id"))):$me.hasClass("ib-used")&&($me.removeClass("ib-used"),detachToken($me.attr("id")))}),content.indexOf("{{download_link}}")!==-1?hasDownload||(hasDownload=!0,updateLink(1)):hasDownload&&(hasDownload=!1,updateLink(0))}function attachToken(field_id){$.ajax({data:{action:"attach_template_token",email_id:template_id,field_id:field_id},dataType:"json",type:"post",url:ibAjax.ajaxurl})}function detachToken(field_id){$.ajax({data:{action:"detach_template_token",email_id:template_id,field_id:field_id},dataType:"json",type:"post",url:ibAjax.ajaxurl})}function updateLink(val){$.ajax({data:{action:"set_download_link_bool",email_id:template_id,link_value:val},dataType:"json",type:"post",url:ibAjax.ajaxurl})}var hasDownload,template_id=$("#email_id").val();"undefined"!=typeof tinymce&&tinymce.on("AddEditor",function(e){e.editor.on("keyup",function(e){var content=this.getContent();checkUsage(content)}),e.editor.on("change",function(e){var content=this.getContent();checkUsage(content)})})});