!function($){var dir=1,MIN_TOP=200,MAX_TOP=350;$.fn.ib_emailEditor=function(method){var _ibThis,_previewFrame,_currentImageSelector,_mediaWindow,_form,defaults={data:"",type:"template",spinner:'<span class="fa fa-spinner fa-pulse fa-2x"></span>',preview_frame:"#ib-email-template-iframe",form_selector:"#ib_save_email_template",contact_forms:[]},methods={sticky_relocate:function(){var window_top=$(window).scrollTop(),div_top=$("#sticky-anchor").offset().top,width=$("#sticky-anchor").width();window_top>div_top?($("#sticky").addClass("stick"),$("#sticky").width(width),$("#sticky-anchor").height($("#sticky").outerHeight())):($("#sticky").removeClass("stick"),$("#sticky-anchor").height(0))},autoscroll:function(){var window_top=$(window).scrollTop()+dir;window_top>=MAX_TOP?(window_top=MAX_TOP,dir=-1):window_top<=MIN_TOP&&(window_top=MIN_TOP,dir=1),$(window).scrollTop(window_top),window.setTimeout(autoscroll,100)},init:function(options){_form=_ibThis.find(settings.form_selector),_ibThis.find("#editor_tabs").ib_ctaTabs(),_ibThis.find("div.ib_slider-value > input").each(function(){$(this).on("change",function(){methods.updateTextLinkedSliderScrubber($(this))})}),_ibThis.find(".ui-slider").each(function(){$(this).slider({min:$(this).data("min")||0,max:$(this).data("max")||100,value:$(this).data("value")||0,change:function(event,slider){var $slider=$(this);methods.updateSliderLinkedTextfield($slider)}})});var $colorPickers=$(".ib_color-picker");$colorPickers.each(function(){var $me=$(this);$me.after('<span class="ib_color-pick">&nbsp;</span>');var prevColor=$me.val(),$colorPreview=$me.next(".ib_color-pick");prevColor.length&&$colorPreview.css("background-color","#"+prevColor),$colorPreview.click(function(){$(this).prev(".ib_color-picker").trigger("click")}),$me.colpick({layout:"hex",submit:0,colorScheme:"light",onChange:function(hsb,hex,rgb,el,bySetColor){var $el=$(el);$el.next(".ib_color-pick").css("background-color","#"+hex),hex!=$el.val()&&($el.val(hex),$el.trigger("change"))}}),$me.on("change",function(){$me.colpickSetColor($me.val(),!0)})}),_previewFrame=$(settings.preview_frame),_previewFrame.load(ibEmailAjax.ajaxurl+"?action=ib_get_email_template_preview&nonce="+ibEmailAjax.ibEmailNonce,function(){setTimeout(function(){methods.emailPreviewReady()},1e3)}),$(window).scroll(methods.sticky_relocate),methods.sticky_relocate(),_ibThis.find('input[type="text"],input[type="hidden"],select').on("change",function(){methods.handleInputChange($(this))}),_ibThis.on("keypress",":input:not(textarea)",function(event){13==event.keyCode&&event.preventDefault()}),_ibThis.find(".ib_media-select .ib-button").each(function(){$(this).click(function(){methods.chooseImage($(this).parent())})}),_ibThis.find('input[type="checkbox"]').on("click",function(){methods.handleInputChange($(this))}),_ibThis.find("#cancelButton").click(function(event){event.preventDefault(),methods.confirmCancel()}),"undefined"!=typeof tinymce&&(tinymce.on("AddEditor",function(e){e.editor.on("keyup",function(e){var content=this.getContent();methods.emailBodyCopyChanged(content)}),e.editor.on("change",function(e){var content=this.getContent();methods.emailBodyCopyChanged(content)})}),$("#EmailEmailValue").keyup(function(e){var content=$(this).val();methods.emailBodyCopyChanged(content)})),$("#ib_send-text-email").click(function(e){e.preventDefault(),methods.sendTestEmail($(this).parent())}),methods.setFormValidation(),$("#EmailEmailTitle").on("blur",function(){methods.verifyTitle()})},emailBodyCopyChanged:function(content){var $selector=_previewFrame.contents().find("#body"),tokens=content.match(/\{\{(.*?)\}\}/g);if(tokens.length>0&&!jQuery.isEmptyObject(settings.contact_forms))for(var t in tokens){conflicts=[];var token=tokens[t].replace(/\{/g,"").replace(/\}/g,"");if("download_link"!=token){conflicts[token]=[];for(var cf in settings.contact_forms){var form=settings.contact_forms[cf],found=!1;for(var f in form.fields){var field=form.fields[f];if(field==token){found=!0;break}}found||conflicts.push(form.post_title.replace(/\"/g,"&quot;"))}if(conflicts.length>0){var tag='<span class="ib_tipsy ib_token-error" data-conflicts="'+conflicts.join("|")+'">{{'+token+"}}</span>";content=content.replace("{{"+token+"}}",tag)}}}$selector.html(content)},confirmCancel:function(){$.confirm({title:"Cancel?",content:"Are you sure you want exit? You will lose any changes made.",confirm:function(){window.location.href=settings.cancel_url},confirmButton:"Leave This Page",cancelButton:"Stay",confirmButtonClass:"ib_save",cancelButtonClass:"ib_cancel"})},handleContainer:function($checkbox,$container){var $divs=$($checkbox.data("group"));$checkbox.is(":checked")?($divs.slideDown(),$container.show()):($divs.slideUp(),$container.hide())},setFormValidation:function(){_form.validate()},handleInputChange:function($input){var $selector=_previewFrame.contents().find($input.data("selector")),changes=$input.data("changes"),value=$input.val();switch(changes){case"css":var property=$input.data("property");"text-align"==property?value=value:property.indexOf("color")==-1?value+="px":value="#"+value,$selector.css(property,value);break;case"attribute":var attribute=$input.data("attribute");$selector.attr(attribute,value),"src"==attribute&&(value.length?$selector.show():$selector.hide());break;case"custom":var property=$input.data("property");switch(property){case"icon_size":$selector.find("span.fa").each(function(){var $me=$(this),network=$me.parent().data("network");$me.attr("class","fa fa-"+network+"-square fa-"+value+"x")});break;case"icon_spacing":$selector.find("span.fa").each(function(){$(this).css("margin-left",value+"px")});break;case"icon_facebook":case"icon_twitter":case"icon_linkedin":case"icon_google-plus":var network=property.replace("icon_",""),$icon=$selector.find('a[data-network="'+network+'"]');$input.is(":checked")?$icon.show():$icon.hide()}break;case"container":methods.handleContainer($input,$selector);break;case"html":var after=$input.data("after");void 0!=after&&(value+=after),$selector.html(value)}methods.resizeFrame()},updateSliderLinkedTextfield:function($slider){$input=$slider.prev().find("input");var value=$slider.slider("option","value");$input.val()!=value&&($input.val(value),$input.trigger("change"))},updateTextLinkedSliderScrubber:function($input){$slider=$input.parent().next(),console.log($slider),$slider.slider("value")!=$input.val()&&$slider.slider("value",$input.val())},emailPreviewReady:function(){if(_ibThis.find("input,select").trigger("change"),_ibThis.find('input[type="checkbox"]').each(function(){methods.handleInputChange($(this))}),"undefined"!=typeof tinymce){var content=getWPEditorContent("EmailEmailValue");methods.emailBodyCopyChanged(content)}_previewFrame.contents().find("link").each(function(){var $link=$(this);$link.attr("href",$link.attr("href")+"?id="+(new Date).getMilliseconds())}),_previewFrame.show(),methods.resizeFrame()},chooseImage:function($media_selector){_currentImageSelector=$media_selector,_mediaWindow?_mediaWindow.open():(_mediaWindow=wp.media.frames._mediaWindow=wp.media({title:"Choose Image",button:{text:"Choose Selected"},multiple:!1}),_mediaWindow.on("select",function(){attachment=_mediaWindow.state().get("selection").first().toJSON();var imgurl=attachment.url;_currentImageSelector.find("input").val(imgurl).trigger("change")}),_mediaWindow.open())},setImageProperty:function(state,thumbnail,image_url){var stateC=state.charAt(0).toUpperCase()+state.slice(1);thumbnail||(thumbnail=_ibThis.find("#CallToAction"+stateC+"CtaThumbnail").val()),image_url||(image_url=_ibThis.find("#CallToAction"+stateC+"CtaImageUrl").val()),_ibThis.find("#"+state+"_cta_thumbnail").html('<img src="'+thumbnail+'">');var img_cta='<img src="'+image_url+'" alt="Submit">';_ctaPreviewButton.html(img_cta),methods.updateHtmlPreview()},resizeFrame:function(){if(_previewFrame.is(":visible")){var $body=_previewFrame.contents().find("body");if($body.length){var height=parseFloat($body.outerHeight())+20;_previewFrame.attr("height",height+"px")}}},sendTestEmail:function($container){if(!_lockClick){_lockClick=!0,$container.addClass("sending");var $action=_form.find('input[name="action"]'),action=$action.val();$action.val("ib_send_test_email");var post=_form.serialize()+"&nonce="+ibEmailAjax.ibEmailNonce;$action.val(action),$.ajax({url:ibEmailAjax.ajaxurl,dataType:"json",type:"post",data:post,success:function(response,status){$container.removeClass("sending"),_lockClick=!1,$.alert({title:response.title,content:response.message,confirmButtonClass:"ib_save"})},error:function(jqXhr,textStatus,errorThrown){console.log(errorThrown),$container.removeClass("sending"),_lockClick=!1}})}},verifyTitle:function(){var name=$("#EmailEmailTitle").val(),email_id=$("#EmailEmailId").val();name&&(data={action:"ib_verify_email_title",nonce:ibEmaiAjaxl.ibSettingsNonce,title:name,email_id:email_id},$.ajax({url:ibEmaiAjaxl.ajaxurl,dataType:"json",type:"post",data:data,success:function(response,status){response.success?($(".save_btn").prop("disabled",!1).css("background","#0083CA"),$("#EmailTitle-error").hide()):($.alert({title:"Error!",content:response.message,confirmButtonClass:"ib_save"}),$("#EmailEmailTitle").removeClass("valid").addClass("error"),$(".save_btn").prop("disabled",!0).css("background","#87bfde"),$("#EmailTitle-error").text(response.message).show())},error:function(jqXhr,textStatus,errorThrown){console.log(errorThrown),_lockClick=!1}}))}},_lockClick=!1,settings=$.extend({},defaults,method);return methods[method]?(_ibThis=$(this),methods[method].apply(this,Array.prototype.slice.call(arguments,1))):"object"!=typeof method&&method?void $.error("Method "+method+" does not exist on jQuery.ib_ctaLists"):this.each(function(){_ibThis=$(this),methods.init()})}}(jQuery);